/**
 * Extracts the acknowledgement and funding sections from a research article using DOI
 * Uses Firecrawl to bypass publisher blocks
 * @param {string} doi - The DOI of the article
 * @return {string} Plain text acknowledgement/funding section or error
 * @customfunction
 */
function GET_ACKNOWLEDGEMENT_SB(doi) {
  if (!doi) return "Error: No DOI provided";

  doi = doi.replace(/^https?:\/\/(dx\.)?doi\.org\//i, '').trim();

  var cache = CacheService.getScriptCache();
  var cacheKey = 'ack_' + doi;
  var cached = cache.get(cacheKey);
  if (cached) return cached;

  try {
    // === Firecrawl Configuration ===
    var FIRECRAWL_API_KEY = 'fc-44469800c0b54f36ab956063ccbe100d';
    var targetUrl = "https://doi.org/" + doi;
    
    // Build Firecrawl API request with optimized options for academic articles
    var firecrawlUrl = 'https://api.firecrawl.dev/v1/scrape';
    
    var payload = {
      url: targetUrl,
      formats: ['html'],              // Get HTML for parsing
      onlyMainContent: true,          // Focus on article content, exclude nav/ads
      excludeTags: ['nav', 'footer', 'script', 'style', 'iframe'],  // Remove unnecessary elements
      waitFor: 3000,                  // Wait 3 seconds for dynamic content to load
      timeout: 60000,                 // Allow 60 seconds for complex publisher sites
      removeBase64Images: true        // Remove embedded images to reduce response size
    };

    var options = {
      method: 'post',
      contentType: 'application/json',
      headers: {
        'Authorization': 'Bearer ' + FIRECRAWL_API_KEY
      },
      payload: JSON.stringify(payload),
      muteHttpExceptions: true
    };

    var response = UrlFetchApp.fetch(firecrawlUrl, options);

    var code = response.getResponseCode();
    if (code !== 200) {
      var err = "Error: Could not fetch article page (HTTP " + code + ")";
      cache.put(cacheKey, err, 1800);
      return err;
    }

    var responseData = JSON.parse(response.getContentText());
    
    // Firecrawl returns HTML in the 'html' field of the response
    if (!responseData.success || !responseData.data || !responseData.data.html) {
      var err = "Error: Invalid response from Firecrawl";
      cache.put(cacheKey, err, 1800);
      return err;
    }
    
    var html = responseData.data.html;
    html = html.replace(/[\r\n]+/g, ' ');

    // === Initialize sections ===
    var sections = { acknowledgement: [], funding: [] };
    var seenContentHashes = {};

    // --- 1. Heading-based extraction ---
    var headingRegex = /<h([1-6])[^>]*>([\s\S]*?)<\/h\1>/gi;
    var headings = [];
    var match;
    while ((match = headingRegex.exec(html)) !== null) {
      headings.push({
        level: parseInt(match[1]),
        text: match[2],
        start: match.index,
        end: headingRegex.lastIndex
      });
    }
    headings.push({ start: html.length, level: 0 });

    for (var i = 0; i < headings.length - 1; i++) {
      var current = headings[i];
      var next = headings[i + 1];

      var label = current.text.replace(/<[^>]+>/g, '').trim().toLowerCase();
      var isAck = /acknowledgement?s?|acknowledgment?s?/.test(label);
      var isFund = /funding/.test(label);
      if (!isAck && !isFund) continue;

      var contentHtml = html.substring(current.end, next.start).trim();
      var cleaned = contentHtml.replace(/<[^>]+>/g, ' ')
                               .replace(/&[a-z]+;|&#\d+;/gi, ' ')
                               .replace(/\s+/g, ' ')
                               .trim();
      if (cleaned.length < 20) continue;

      var hash = cleaned.substring(0, 300);
      if (seenContentHashes[hash]) continue;
      seenContentHashes[hash] = true;

      if (isAck && isFund) {
        sections.acknowledgement.push(cleaned);
        sections.funding.push(cleaned);
      } else if (isAck) {
        sections.acknowledgement.push(cleaned);
      } else if (isFund) {
        sections.funding.push(cleaned);
      }
    }

    // --- 2. Publisher-specific container fallback ---
    if (sections.acknowledgement.length === 0 && sections.funding.length === 0) {
      var containerPatterns = [
        /<section[^>]*(?:class|id)="[^"]*(?:acknowledgement?|acknowledgment|funding)[^"]*"[^>]*>([\s\S]*?)<\/section>/gi,
        /<div[^>]*(?:class|id)="[^"]*(?:acknowledgement?|acknowledgment|funding)[^"]*"[^>]*>([\s\S]*?)<\/div>/gi,
        /<div[^>]*class="[^"]*funding-statement[^"]*"[^>]*>([\s\S]*?)<\/div>/gi,
        /<section[^>]*class="[^"]*(?:hlFld-Acknowledgements?|hlFld-Funding)[^"]*"[^>]*>([\s\S]*?)<\/section>/gi,
        /<div[^>]*class="[^"]*article-header__references-container[^"]*"[^>]*>([\s\S]*?)<\/div>/gi,
        /<div[^>]*class="[^"]*header-note-content[^"]*"[^>]*>([\s\S]*?)<\/div>/gi
      
      ];

      for (var p = 0; p < containerPatterns.length; p++) {
        var matches = html.match(containerPatterns[p]);
        if (!matches) continue;

        for (var j = 0; j < matches.length; j++) {
          var content = matches[j].replace(containerPatterns[p], '$1') || matches[j];
          var cleaned = content.replace(/<[^>]+>/g, ' ')
                               .replace(/&[a-z]+;|&#\d+;/gi, ' ')
                               .replace(/\s+/g, ' ')
                               .trim();
          if (cleaned.length < 20) continue;
          var hash = cleaned.substring(0, 300);
          if (seenContentHashes[hash]) continue;
          seenContentHashes[hash] = true;

          var isAck = /acknowledgement?s?|acknowledgment?s?/.test(matches[j]);
          var isFund = /funding/.test(matches[j]);

          if (isAck && isFund) {
            sections.acknowledgement.push(cleaned);
            sections.funding.push(cleaned);
          } else if (isAck) {
            sections.acknowledgement.push(cleaned);
          } else if (isFund) {
            sections.funding.push(cleaned);
          }
        }
      }
    }

    // --- 3. Combine and return ---
    function selectLongest(arr) {
      if (!arr || arr.length === 0) return null;
      var max = '';
      for (var k = 0; k < arr.length; k++) if (arr[k].length > max.length) max = arr[k];
      return max;
    }

    var ackText = selectLongest(sections.acknowledgement);
    var fundText = selectLongest(sections.funding);
    var result = '';
    if (ackText && fundText) result = ackText + "\n\nFunding:\n" + fundText;
    else if (ackText) result = ackText;
    else if (fundText) result = fundText;
    else result = "No acknowledgement section found";

    if (result.length > 5000) result = result.substring(0, 5000) + "...";

    cache.put(cacheKey, result, 21600);
    return result;

  } catch (e) {
    return "Error: " + e.toString();
  }
}
